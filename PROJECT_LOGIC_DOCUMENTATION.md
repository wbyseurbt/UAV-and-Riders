# 无人机与骑手协同配送仿真系统 - 逻辑说明文档

本文档详细描述了 `UAV-and-Riders` 项目的仿真逻辑、角色行为、协同机制及强化学习设计。文档内容基于最新代码实现（包含修复瞬移、电量预判、超时兜底等逻辑）。

---

## 1. 项目概述

本项目是一个基于强化学习（Reinforcement Learning, RL）的单智能体（Single-Agent）协同配送仿真环境。系统模拟了一个包含**商店、站点（无人机枢纽）、骑手、无人机**的物流网络。

**核心目标**：通过控制**骑手的路径选择**（直送 vs 站点交接）和**站点的调度决策**（无人机发射），在有限时间内最大化配送效率（多送单、少等待、少能耗）。

---

## 2. 角色详解

### 2.1 骑手 (Rider)

骑手是物流网络中的“毛细血管”，负责灵活的短途运输。

*   **移动方式**：
    *   在网格地图（Grid）上按曼哈顿距离移动（只能上下左右）。
    *   **无瞬移**：所有任务（取货、送货）都必须一步步走到目标点。
    *   速度：需累积“移动缓冲”才能迈出一步（模拟速度差异）。

*   **行为逻辑**：
    1.  **接单（第一公里）**：
        *   系统生成订单后，分配给距离商店最近的空闲骑手。
        *   骑手状态转为 `BUSY`，步行前往商店取货。
        *   到店后，订单状态变为 `PICKED_BY_R1`。
    2.  **决策（中途）**：
        *   **策略控制**：RL 策略决定骑手是“直送终点”还是“前往某个站点交接”。
        *   **强制交接**：训练时以一定概率强制骑手去最近站点（前提：直送距离 > 2倍去站距离，避免绕路）。
    3.  **派送（最后一公里）**：
        *   当站点有待派送订单时，呼叫最近的空闲骑手。
        *   骑手步行至站点，取货（状态 `PICKED_BY_R2`），送往终点。
    4.  **空闲**：
        *   无任务时，根据策略动作决定是原地待命还是去站点候单。

### 2.2 无人机 (UAV)

无人机是物流网络中的“大动脉”，负责站点间的高效干线运输。

*   **移动方式**：
    *   在欧氏空间直线飞行，无视地形阻挡。
    *   速度快（通常为骑手的 3 倍）。
    *   **能耗**：飞行持续耗电，电量归零仍在飞（但在发射前有严格检查）。

*   **行为逻辑**：
    1.  **起飞条件**：
        *   有任务（顺路订单或空机支援）。
        *   **电量预判**：当前电量 - 预计飞行耗电 >= 10%，否则禁止起飞。
    2.  **装载**：
        *   **严格顺路**：只装载去往目标站点的订单，不拼单。
        *   **急件优先**：优先装等待最久的订单。
    3.  **降落与充电**：
        *   到达目标站后，瞬间卸货（订单进入站点待派送区）。
        *   立即进入 `CHARGING` 状态，每步恢复 10% 电量。

### 2.3 站点 (Station)

站点是物流网络的“枢纽”，负责无人机调度与订单中转。

*   **功能**：
    *   **订单缓冲**：暂存骑手送来的订单 (`orders_waiting`)。
    *   **无人机停泊**：管理可用无人机 (`uav_available`)。
    *   **待派送管理**：暂存无人机送来的订单 (`orders_to_deliver`)。

*   **调度逻辑**：
    *   **发射决策**：RL 策略输出动作（飞往哪个站）。
    *   **空机调度**：如果目标站缺车（无车且有积压），允许发射空车支援。
    *   **兜底机制**：如果订单在缓冲池积压超过 60 步（超时），自动转为“待派送”，呼叫骑手直接送走（转人工）。

---

## 3. 订单全生命周期

一个典型的订单可能经历以下状态流转：

1.  **UNASSIGNED**：系统生成订单，分配给骑手，骑手在路上。
2.  **PICKED_BY_R1**：骑手到达商店，取货成功。
3.  **AT_STATION**：骑手到达源站点，卸货。订单进入 `orders_waiting`。
4.  **IN_UAV**：站点调度无人机，装载订单起飞。
5.  **AT_DROP_POINT**：无人机到达目标站点，卸货。订单进入 `orders_to_deliver`。
6.  **PICKED_BY_R2**：目标站点呼叫骑手，骑手取货配送最后一公里。
7.  **DELIVERED**：骑手到达用户终点，订单完成。

> **注**：如果在步骤 2 骑手选择直送，则跳过 3-6，直接变 `DELIVERED`。

---

## 4. 强化学习设计 (RL)

### 4.1 观测空间 (Observation)
每个时间步，Agent 收到一个拼接向量，包含：
*   **骑手信息**：位置、携单状态、等待时间、到各站点的距离/拥堵/UAV数。
*   **站点信息**：位置、积压量、可用UAV数、面向各目标站的“需求热度”（候选订单数、等待时间）。

### 4.2 动作空间 (Action)
*   **MultiDiscrete** 空间，长度 = 骑手数 + 站点数。
*   **骑手动作**：`0`=直送/待命，`1~N`=前往站点 i。
*   **站点动作**：`0`=不发射，`1~N`=向站点 i 发射。

### 4.3 奖励函数 (Reward)
*   **正向**：送达订单 (+0.5)，邻站支援 (+0.003)，合理交接 (+0.05)。
*   **负向**：积压订单 (-0.01/个)，总等待时间 (-0.0001)，超时订单 (-1.0)，发射成本 (-0.0001)，站点溢出 (-0.02)。
*   **截断惩罚**：积压 > 50 单时，给予 -200 并强制结束回合。

---

## 5. 关键参数 (Configs)

| 参数名 | 默认值 | 说明 |
| :--- | :--- | :--- |
| `n_riders` | 20 | 骑手总数 |
| `n_stations` | 5 | 站点数量（由位置列表决定） |
| `uav_speed` | Rider*3 | 无人机速度倍率 |
| `uav_capacity` | 5 | 无人机单次载单上限 |
| `force_station_prob` | 0.2 | 训练时强制交接的概率 |

---
*文档生成时间：2026-02-11*
